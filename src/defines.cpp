#include <Arduino.h>
#include <defines.h>
#include <webServer.h>

#include "driver/rmt.h"
#include "freertos/FreeRTOS.h"
#include "freertos/queue.h"
#include "freertos/semphr.h"
#include "freertos/task.h"

bool bArrMotorLiberado[] = {true, true, true, true, true};
bool bArrDedoContraido[] = {false, false, false, false, false};
bool bArrSobrecorrenteDetectada[5] = {false, false, false, false, false};
bool bArrMotorEstadoTravado[5] = {false, false, false, false, false};
bool bModoTreino = true;
bool bCalibDone = false;

const uint8_t uiFreqModulacaoNeoPixelAtivado = 3;  // 3 clicos desativados para 1 ativado (valor de 1 Ã© constante)
const uint8_t MOTOR_PIN[] = {MOTOR1, MOTOR2, MOTOR3, MOTOR4, MOTOR5, MOTOR_VIB};

uint8_t uiConterFreqModulacaoNeoPixel = 0;
uint8_t uiContadorTreino = 0;
uint8_t uiTreinoE = 0;
uint8_t uiTreinoVal = 0;
uint8_t uiCliclosCorrenteAlta = 5;
uint8_t uiArrPwmCorrenteAtingida = 0;  // 0 = Solta o objeto ao travar. Mude para 30-50 se quiser segurar.
uint8_t uiArrContadorCiclosAlta[5] = {0, 0, 0, 0, 0};
uint8_t uiVetorDedosTreino[5] = {0, 0, 0, 0, 0};
uint8_t uiArrCorNeoPixel[] = {196, 196, 196};
uint8_t uiArrPwmLevels[] = {0, 0, 0, 0, 0, 0};
uint8_t uiArrPwmRampa[] = {0, 0, 0, 0, 0, 0};
uint8_t uiCorNeoPixelInterno[] = {0, 0, 0};

int iContadorChamdaSensorFoto = 0;
int iCorrenteMaxima = 250;
int iPosServo[] = {0, 0, 0, 0, 0};

Servo servoPolegar;
Servo servoIndicador;
Servo servoMedio;
Servo servoAnelar;
Servo servoMindinho;

SemaphoreHandle_t xNeoPixelMutex = NULL;   // Trava as variaveis: colorTable, uiArrCorNeoPixel
SemaphoreHandle_t xAtuaMotorMutex = NULL;  // Trava as variaveis: bArrMotorLiberado, bArrDedoContraido, uiArrPwmLevels, uiArrPwmRampa
SemaphoreHandle_t xSensorFotoMutex = NULL;
SemaphoreHandle_t xEstatisticaMutex = NULL;

float fTreinoCount = 0.0;
float fArrDadosSensorFotoBruto[4][8] = {
    {0, 0, 0, 0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0},
    {0, 0, 0, 0, 0, 0, 0, 0}};
float fArrDadosSensorFoto[4] = {0, 0, 0, 0};
float fTreinoSum[4] = {0, 0, 0, 0};
float fTreinoSumSq[4] = {0, 0, 0, 0};
float fArrSensorCorrente[5] = {0, 0, 0, 0, 0};

/* __________________________________ PESOS REDES NEURAIS ____________________________________________ */
const float fLayerBias[20] = {4.47901, -8.62447, -9.29635, 0.961847, -10.7459, -16.6561, -1.70799, -10.386, 2.81813, -12.9954, 3.69791, -3.95575, 0.7841, 3.8682, 2.71583, 7.30832, -12.6524, 5.41394, -5.0113, 5.90714};
const float fLayerWeight[4][20] = {
    {0.18442, 1.47057, 0.101038, 1.87345, -5.59219, -10.3734, -5.73258, -6.2997, 4.14271, -13.2065, -2.32258, 6.55047, 0.44204, 10.6077, -1.0843, 8.30799, 0.724127, -0.191491, -3.35928, -14.1297},
    {-2.67382, -3.03553, -0.31085, 6.95736, 2.35131, -8.14936, 5.9366, 0.21222, 4.23522, -0.0501755, -1.34691, -8.58028, 5.20288, 2.06311, -0.212327, 11.1442, -13.7504, 3.59577, -8.50325, -1.01287},
    {0.786138, 1.50303, 6.37038, -2.13202, -9.19638, 3.66151, 11.9546, -2.19104, 1.41342, 4.04153, -5.49922, -9.72117, -5.83284, 0.661724, 10.2064, -8.08857, -1.47474, 1.46678, 1.88344, 9.94376},
    {-4.0526, -0.85512, 5.52536, -4.52934, 11.7396, -0.830014, -10.33, -6.03803, -11.6618, -4.96708, 10.6298, 1.43018, -12.2167, -5.832, -4.87139, 2.04755, -2.28999, -10.326, 9.70061, 3.04629}};
const float fW1[4][20] = {
    {0.18442, 1.47057, 0.101038, 1.87345, -5.59219, -10.3734, -5.73258, -6.2997, 4.14271, -13.2065, -2.32258, 6.55047, 0.44204, 10.6077, -1.0843, 8.30799, 0.724127, -0.191491, -3.35928, -14.1297},
    {-2.67382, -3.03553, -0.31085, 6.95736, 2.35131, -8.14936, 5.9366, 0.21222, 4.23522, -0.0501755, -1.34691, -8.58028, 5.20288, 2.06311, -0.212327, 11.1442, -13.7504, 3.59577, -8.50325, -1.01287},
    {0.786138, 1.50303, 6.37038, -2.13202, -9.19638, 3.66151, 11.9546, -2.19104, 1.41342, 4.04153, -5.49922, -9.72117, -5.83284, 0.661724, 10.2064, -8.08857, -1.47474, 1.46678, 1.88344, 9.94376},
    {-4.0526, -0.85512, 5.52536, -4.52934, 11.7396, -0.830014, -10.33, -6.03803, -11.6618, -4.96708, 10.6298, 1.43018, -12.2167, -5.832, -4.87139, 2.04755, -2.28999, -10.326, 9.70061, 3.04629}};
const float fW2[20][8] = {
    {1.10568, -15.4685, 4.15184, -0.644916, 10.5928, -2.83497, 3.34991, 0.571192},
    {-7.16126, 0.335714, 4.91389, 3.16451, -5.08667, 1.65217, 2.80379, -1.01847},
    {0.200542, -3.15288, -0.102055, 2.6886, 11.3023, -10.2945, -1.6653, 0.776834},
    {2.02283, -9.77762, -4.78715, -14.1607, 1.09415, 5.50094, 6.45304, 13.9306},
    {-10.2102, 6.29187, 0.468017, -0.0300419, 1.98539, 2.09293, 0.478618, -0.636436},
    {-8.79319, -0.864707, 5.921, 8.09329, -4.87596, -6.33565, 10.9404, -4.03739},
    {5.67117, -9.31419, -5.43593, 1.95154, -7.68562, 8.14962, 2.06535, 5.92709},
    {-5.89363, -2.81258, 0.792462, 4.30113, 6.3015, -4.72041, -0.288504, 1.85154},
    {3.70894, -3.22842, -11.5628, 1.25111, -6.13198, 3.51102, 9.50403, 2.94456},
    {9.63532, -0.148968, -7.66763, -8.80168, 4.23934, -11.3638, 6.68812, 9.64692},
    {-0.766218, 5.19814, 0.665119, 1.13502, 4.0559, -0.312883, -9.48611, 0.234593},
    {-5.39999, 0.436886, -0.754494, 8.63702, 9.58898, -19.7833, 10.501, -3.32264},
    {-19.5821, -1.77857, -8.59045, 8.79018, 1.23745, 9.89382, 6.79848, 2.68533},
    {-4.7843, 1.32821, -6.98, 2.22298, 13.8228, -0.601055, -2.23942, -3.84741},
    {-11.9564, 5.05181, 1.37908, -1.11267, -9.90434, 5.01443, 13.9471, -1.57998},
    {2.0344, 5.57598, 0.365474, -5.05139, 10.1102, 2.17898, -6.93592, -7.41063},
    {10.1199, -3.79251, 3.51753, -8.79261, -15.6309, 10.7374, 0.793803, 4.07206},
    {-9.79638, -7.33107, 0.421089, -0.236543, 17.1576, -0.295971, 0.459541, 0.0892463},
    {2.51549, -7.92079, -7.7451, 3.31912, 0.385021, -3.88355, 13.9015, -0.0780286},
    {-0.612359, -3.76867, 3.60188, 1.49565, 5.97969, -7.48649, 0.52504, 1.01611}};
const float fB1[20] = {4.47901, -8.62447, -9.29635, 0.961847, -10.7459, -16.6561, -1.70799, -10.386, 2.81813, -12.9954, 3.69791, -3.95575, 0.7841, 3.8682, 2.71583, 7.30832, -12.6524, 5.41394, -5.0113, 5.90714};
const float fB2[8] = {20.8937, -5.78672, -0.236016, -1.40611, -1.16134, -3.51904, -5.5824, -3.20206};
const float fCost[8][8] = {
    {0, 1, 1, 1, 1, 1, 1, 1},
    {1, 0, 1, 1, 1, 1, 1, 1},
    {1, 1, 0, 1, 1, 1, 1, 1},
    {1, 1, 1, 0, 1, 1, 1, 1},
    {1, 1, 1, 1, 0, 1, 1, 1},
    {1, 1, 1, 1, 1, 0, 1, 1},
    {1, 1, 1, 1, 1, 1, 0, 1},
    {1, 1, 1, 1, 1, 1, 1, 0}};
const float fPrior[8] = {0.46747, 0.066566, 0.066566, 0.066566, 0.13313, 0.066566, 0.066566, 0.066566};
float fMu[4] = {0, 0, 0, 0};
float fSigma[4] = {0, 0, 0, 0};